<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>ROOT: tutorials/multicore/imt101_parTreeProcessing.C File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ROOT.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table bgcolor="#346295" cellspacing="0" cellpadding="0">
  <tr>
    <td> <img style="height:90px" alt="Logo" src="rootlogo.gif"/> </td>
    <td valign="middle" style="color: #FFFFFF" nowrap="nowrap"><font size="6">ROOT</font> &#160; 6.18/03 <br> Reference Guide </td>
    <td style="width:100%"> </td>
  </tr>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_0d353d24d0afa59909efab6593124f6d.html">tutorials</a></li><li class="navelem"><a class="el" href="dir_b2d2b4e27d077f7d4f8f12bfa35378a6.html">multicore</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">imt101_parTreeProcessing.C File Reference<div class="ingroups"><a class="el" href="group__Tutorials.html">Tutorials</a> &raquo; <a class="el" href="group__tutorial__multicore.html">Multicore tutorials</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p> <a href="http://nbviewer.jupyter.org/url/root.cern.ch/doc/master/notebooks/imt101_parTreeProcessing.C.nbconvert.ipynb" target="_blank"><img src= notebook.gif alt="View in nbviewer" style="height:1em" ></a> <a href="https://cern.ch/swanserver/cgi-bin/go?projurl=https://root.cern.ch/doc/master/notebooks/imt101_parTreeProcessing.C.nbconvert.ipynb" target="_blank"><img src="http://swanserver.web.cern.ch/swanserver/images/badge_swan_white_150.png"  alt="Open in SWAN" style="height:1em" ></a>  Illustrate the usage of the TTreeProcessorMT::Process method. </p>
<p>Such method provides an implicit parallelisation of the reading and processing of a <a class="el" href="classTTree.html" title="A TTree represents a columnar dataset. ">TTree</a>. In particular, when invoking Process, the user provides a function that iterates on a subrange of the tree via a <a class="el" href="classTTreeReader.html" title=" A simple, robust and fast interface to read values from ROOT columnar datasets such as TTree...">TTreeReader</a>. Multiple tasks will be spawned, one for each sub-range, so that the processing of the tree is parallelised. Since two invocations of the user function can potentially run in parallel, the function code must be thread safe. The example also introduces a new class, <a class="el" href="classROOT_1_1TThreadedObject.html" title="A wrapper to make object instances thread private, lazily. ">ROOT::TThreadedObject</a>, which makes objects thread private. With the help of this class, histograms can be filled safely inside the user function and then merged at the end to get the final result.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="keywordtype">int</span> imt101_parTreeProcessing()</div><div class="line">{</div><div class="line">   <span class="comment">// First enable implicit multi-threading globally, so that the implicit parallelisation is on.</span></div><div class="line">   <span class="comment">// The parameter of the call specifies the number of threads to use.</span></div><div class="line">   <span class="keywordtype">int</span> nthreads = 4;</div><div class="line">   <a class="code" href="namespaceROOT.html#a06f2b8b216b615e5abbc872c9feff40f">ROOT::EnableImplicitMT</a>(nthreads);</div><div class="line"></div><div class="line">   <span class="comment">// Create one TThreadedObject per histogram to fill during the processing of the tree</span></div><div class="line">   <a class="code" href="classROOT_1_1TThreadedObject.html">ROOT::TThreadedObject&lt;TH1F&gt;</a> ptHist(<span class="stringliteral">&quot;pt_dist&quot;</span>, <span class="stringliteral">&quot;p_{T} Distribution;p_{T};dN/p_{T}dp_{T}&quot;</span>, 100, 0, 5);</div><div class="line">   <a class="code" href="classROOT_1_1TThreadedObject.html">ROOT::TThreadedObject&lt;TH1F&gt;</a> pzHist(<span class="stringliteral">&quot;pz_dist&quot;</span>, <span class="stringliteral">&quot;p_{Z} Distribution;p_{Z};dN/dp_{Z}&quot;</span>, 100, 0, 5);</div><div class="line">   <a class="code" href="classROOT_1_1TThreadedObject.html">ROOT::TThreadedObject&lt;TH2F&gt;</a> pxpyHist(<span class="stringliteral">&quot;px_py&quot;</span>, <span class="stringliteral">&quot;p_{X} vs p_{Y} Distribution;p_{X};p_{Y}&quot;</span>, 100, -5., 5., 100, -5., 5.);</div><div class="line"></div><div class="line">   <span class="comment">// Create a TTreeProcessorMT: specify the file and the tree in it</span></div><div class="line">   <a class="code" href="classROOT_1_1TTreeProcessorMT.html">ROOT::TTreeProcessorMT</a> tp(<span class="stringliteral">&quot;http://root.cern.ch/files/tp_process_imt.root&quot;</span>, <span class="stringliteral">&quot;events&quot;</span>);</div><div class="line"></div><div class="line">   <span class="comment">// Define the function that will process a subrange of the tree.</span></div><div class="line">   <span class="comment">// The function must receive only one parameter, a TTreeReader,</span></div><div class="line">   <span class="comment">// and it must be thread safe. To enforce the latter requirement,</span></div><div class="line">   <span class="comment">// TThreadedObject histograms will be used.</span></div><div class="line">   <span class="keyword">auto</span> myFunction = [&amp;](<a class="code" href="classTTreeReader.html">TTreeReader</a> &amp;myReader) {</div><div class="line">      <a class="code" href="classTTreeReaderValue.html">TTreeReaderValue&lt;std::vector&lt;ROOT::Math::PxPyPzEVector&gt;</a>&gt; tracksRV(myReader, <span class="stringliteral">&quot;tracks&quot;</span>);</div><div class="line"></div><div class="line">      <span class="comment">// For performance reasons, a copy of the pointer associated to this thread on the</span></div><div class="line">      <span class="comment">// stack is used</span></div><div class="line">      <span class="keyword">auto</span> myPtHist = ptHist.Get();</div><div class="line">      <span class="keyword">auto</span> myPzHist = pzHist.Get();</div><div class="line">      <span class="keyword">auto</span> myPxPyHist = pxpyHist.Get();</div><div class="line"></div><div class="line">      <span class="keywordflow">while</span> (myReader.Next()) {</div><div class="line">         <span class="keyword">auto</span> <a class="code" href="tracks_8C.html#a42d1c24f70e3a57ddf678273ddbd2624">tracks</a> = *tracksRV;</div><div class="line">         <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;&amp;track : <a class="code" href="tracks_8C.html#a42d1c24f70e3a57ddf678273ddbd2624">tracks</a>) {</div><div class="line">            myPtHist-&gt;Fill(track.Pt(), 1. / track.Pt());</div><div class="line">            myPxPyHist-&gt;Fill(track.Px(), track.Py());</div><div class="line"></div><div class="line">            myPzHist-&gt;Fill(track.Pz());</div><div class="line">         }</div><div class="line">      }</div><div class="line">   };</div><div class="line"></div><div class="line">   <span class="comment">// Launch the parallel processing of the tree</span></div><div class="line">   tp.Process(myFunction);</div><div class="line"></div><div class="line">   <span class="comment">// Use the TThreadedObject::Merge method to merge the thread private histograms</span></div><div class="line">   <span class="comment">// into the final result</span></div><div class="line">   <span class="keyword">auto</span> ptHistMerged = ptHist.Merge();</div><div class="line">   <span class="keyword">auto</span> pzHistMerged = pzHist.Merge();</div><div class="line">   <span class="keyword">auto</span> pxpyHistMerged = pxpyHist.Merge();</div><div class="line"></div><div class="line">   <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><dl class="section date"><dt>Date</dt><dd>26/09/2016 </dd></dl>
<dl class="section author"><dt>Author</dt><dd>Enric Tejedor </dd></dl>

<p class="definition">Definition in file <a class="el" href="imt101__parTreeProcessing_8C_source.html">imt101_parTreeProcessing.C</a>.</p>
</div></div><!-- contents -->
<html>
<body>
<div id="footer" style="background-color:#E5EBF3;">
<small>
<img class="footer" src="rootlogo_s.gif" alt="root"/></a>
ROOT 6.18/03 - Reference Guide Generated on Thu Aug 29 2019 04:10:19 (GVA Time) using Doxygen 1.8.14.
</small>
</div>
</body>
</html>
