<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>ROOT: tutorials/net/fastMergeServer.C File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ROOT.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table bgcolor="#346295" cellspacing="0" cellpadding="0">
  <tr>
    <td> <img style="height:90px" alt="Logo" src="rootlogo.gif"/> </td>
    <td valign="middle" style="color: #FFFFFF" nowrap="nowrap"><font size="6">ROOT</font> &#160; 6.18/03 <br> Reference Guide </td>
    <td style="width:100%"> </td>
  </tr>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_0d353d24d0afa59909efab6593124f6d.html">tutorials</a></li><li class="navelem"><a class="el" href="dir_bf1f374b06ae8970b3ffa8970c4657c3.html">net</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">fastMergeServer.C File Reference<div class="ingroups"><a class="el" href="group__Tutorials.html">Tutorials</a> &raquo; <a class="el" href="group__tutorial__net.html">Net tutorials</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This script shows how to make a simple iterative server that can receive <a class="el" href="classTMemFile.html" title=" A TMemFile is like a normal TFile except that it reads and writes only from memory. ">TMemFile</a> from multiple clients and merge them into a single file without block. </p>
<p>Note: This server assumes that the client will reset the histogram after each upload to simplify the merging.</p>
<p>This server can accept connections while handling currently open connections. Compare this script to <a class="el" href="hserv_8C.html" title="Server program which waits for two clients to connect. ">hserv.C</a> that blocks on accept. In this script a server socket is created and added to a monitor. A monitor object is used to monitor connection requests on the server socket. After accepting the connection the new socket is added to the monitor and immediately ready for use. Once two connections are accepted the server socket is removed from the monitor and closed. The monitor continues monitoring the sockets.</p>
<p>To run this demo do the following:</p><ul>
<li>Open three windows</li>
<li>Start <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> in all three windows</li>
<li>Execute in the first window: .x fastMergerServer.C</li>
<li>Execute in the second and third windows: .x <a class="el" href="treeClient_8C.html" title="Client program which creates and fills 2 histograms and a TTree. ">treeClient.C</a></li>
</ul>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TMessage_8h.html">TMessage.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TBenchmark_8h.html">TBenchmark.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TSocket_8h.html">TSocket.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TH2_8h.html">TH2.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TTree_8h.html">TTree.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TMemFile_8h.html">TMemFile.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TRandom_8h.html">TRandom.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TError_8h.html">TError.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TFileMerger_8h.html">TFileMerger.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TServerSocket_8h.html">TServerSocket.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TPad_8h.html">TPad.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TCanvas_8h.html">TCanvas.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TMonitor_8h.html">TMonitor.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TFileCacheWrite_8h.html">TFileCacheWrite.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> fastMergeServer(<span class="keywordtype">bool</span> cache = <span class="keyword">false</span>) {</div><div class="line">   <span class="comment">// Open a server socket looking for connections on a named service or</span></div><div class="line">   <span class="comment">// on a specified port.</span></div><div class="line">   <span class="comment">//TServerSocket *ss = new TServerSocket(&quot;rootserv&quot;, kTRUE);</span></div><div class="line">   <a class="code" href="classTServerSocket.html">TServerSocket</a> *ss = <span class="keyword">new</span> <a class="code" href="classTServerSocket.html">TServerSocket</a>(9090, <a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>);</div><div class="line">   <span class="keywordflow">if</span> (!ss-&gt;<a class="code" href="classTSocket.html#af05548498926e8ded5cb4e71c4c6c597">IsValid</a>()) {</div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="classTMonitor.html">TMonitor</a> *mon = <span class="keyword">new</span> <a class="code" href="classTMonitor.html">TMonitor</a>;</div><div class="line"></div><div class="line">   mon-&gt;<a class="code" href="classTMonitor.html#a631545e472cb7107d1949da432974b26">Add</a>(ss);</div><div class="line"></div><div class="line">   <a class="code" href="RtypesCore_8h.html#a7c1bc4939263cb6c0f48e434d77ac258">UInt_t</a> clientCount = 0;</div><div class="line">   <a class="code" href="classTMemFile.html">TMemFile</a> *<span class="keyword">transient</span> = 0;</div><div class="line"></div><div class="line">   <a class="code" href="classTFileMerger.html">TFileMerger</a> merger(<a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>,<a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>);</div><div class="line">   merger.SetPrintLevel(0);</div><div class="line"></div><div class="line">   <span class="keyword">enum</span> StatusKind {</div><div class="line">      kStartConnection = 0,</div><div class="line">      kProtocol = 1,</div><div class="line"></div><div class="line">      kProtocolVersion = 1</div><div class="line">   };</div><div class="line">   <span class="keywordflow">if</span> (cache) <span class="keyword">new</span> <a class="code" href="classTFileCacheWrite.html">TFileCacheWrite</a>(merger.GetOutputFile(),32*1024*1024);</div><div class="line">   <span class="keywordflow">while</span> (1) {</div><div class="line">      <a class="code" href="classTMessage.html">TMessage</a> *mess;</div><div class="line">      <a class="code" href="classTSocket.html">TSocket</a>  *<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>;</div><div class="line"></div><div class="line">      <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a> = mon-&gt;<a class="code" href="classTMonitor.html#a3dfb30e40f93faa98435ba52645254ce">Select</a>();</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;IsA() == <a class="code" href="Class_8C.html#adcfdef0a91f6e5dcab5b9c14cf964be5">TServerSocket::Class</a>()) {</div><div class="line">         <span class="keywordflow">if</span> (clientCount &gt; 100) {</div><div class="line">            printf(<span class="stringliteral">&quot;only accept 100 clients connections\n&quot;</span>);</div><div class="line">            mon-&gt;<a class="code" href="classTMonitor.html#ad4afa7b761bd0a132736cc0f8ce9c686">Remove</a>(ss);</div><div class="line">            ss-&gt;<a class="code" href="classTSocket.html#a6d73e219d72b1d9066cc1c9c1257e0f7">Close</a>();</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="classTSocket.html">TSocket</a> *client = ((<a class="code" href="classTServerSocket.html">TServerSocket</a> *)<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>)-&gt;Accept();</div><div class="line">            client-&gt;<a class="code" href="classTSocket.html#af6bbdf49e36b08535a8821ea128422db">Send</a>(clientCount, kStartConnection);</div><div class="line">            client-&gt;<a class="code" href="classTSocket.html#af6bbdf49e36b08535a8821ea128422db">Send</a>(kProtocolVersion, kProtocol);</div><div class="line">            ++clientCount;</div><div class="line">            mon-&gt;<a class="code" href="classTMonitor.html#a631545e472cb7107d1949da432974b26">Add</a>(client);</div><div class="line">            printf(<span class="stringliteral">&quot;Accept %d connections\n&quot;</span>,clientCount);</div><div class="line">         }</div><div class="line">         <span class="keywordflow">continue</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;Recv(mess);</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (mess==0) {</div><div class="line">         <a class="code" href="TError_8h.html#a66cc228e173b5602f3733072c52266b0">Error</a>(<span class="stringliteral">&quot;fastMergeServer&quot;</span>,<span class="stringliteral">&quot;The client did not send a message\n&quot;</span>);</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mess-&gt;<a class="code" href="classTMessage.html#a3d6f99eeb25fe7cc5cbe1d54862e42b5">What</a>() == <a class="code" href="MessageTypes_8h.html#a2c9d6c5dbd9cd6158973ec7f1986f9b9a1e38fa0dd45a6674f10f7618f0ea8375">kMESS_STRING</a>) {</div><div class="line">         <span class="keywordtype">char</span> str[64];</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#ada28655f1bc1f194321160c6fe5cea22">ReadString</a>(str, 64);</div><div class="line">         printf(<span class="stringliteral">&quot;Client %d: %s\n&quot;</span>, clientCount, str);</div><div class="line">         mon-&gt;<a class="code" href="classTMonitor.html#ad4afa7b761bd0a132736cc0f8ce9c686">Remove</a>(<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>);</div><div class="line">         printf(<span class="stringliteral">&quot;Client %d: bytes recv = %d, bytes sent = %d\n&quot;</span>, clientCount, <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;GetBytesRecv(),</div><div class="line">                <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;GetBytesSent());</div><div class="line">         <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;Close();</div><div class="line">         --clientCount;</div><div class="line">         <span class="keywordflow">if</span> (mon-&gt;<a class="code" href="classTMonitor.html#a6dafe5beeb5bb2e9715f2f2a5bcb33c7">GetActive</a>() == 0 || clientCount == 0) {</div><div class="line">            printf(<span class="stringliteral">&quot;No more active clients... stopping\n&quot;</span>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mess-&gt;<a class="code" href="classTMessage.html#a3d6f99eeb25fe7cc5cbe1d54862e42b5">What</a>() == <a class="code" href="MessageTypes_8h.html#a2c9d6c5dbd9cd6158973ec7f1986f9b9a1f55439e32a14c38f4f3d29ce94b4e76">kMESS_ANY</a>) {</div><div class="line"></div><div class="line">         <a class="code" href="RtypesCore_8h.html#adaf6e69e06203ab5ae4994d1e7590647">Long64_t</a> length;</div><div class="line">         <a class="code" href="classTString.html">TString</a> filename;</div><div class="line">         <a class="code" href="RtypesCore_8h.html#a3885b911a54b47a4e61671f45dd45d0b">Int_t</a> clientId;</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#a9be9caf68377c5de8aea44a6809b9d0b">ReadInt</a>(clientId);</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#a9646f9684a5c20d093b6b8a13ea502fa">ReadTString</a>(filename);</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#a5ff82748cfd80c029b08ca8506b631ae">ReadLong64</a>(length); <span class="comment">// &#39;*mess &gt;&gt; length;&#39; is broken in CINT for Long64_t.</span></div><div class="line"></div><div class="line">         <a class="code" href="TError_8h.html#a39df8069c2b64976c8e9330743e1b145">Info</a>(<span class="stringliteral">&quot;fastMergeServer&quot;</span>,<span class="stringliteral">&quot;Receive input from client %d for %s&quot;</span>,clientId,filename.<a class="code" href="classTString.html#a7e4ada8bf2407b461f3ee58b71c5959f">Data</a>());</div><div class="line"></div><div class="line">         <span class="keyword">delete</span> <span class="keyword">transient</span>;</div><div class="line">         <span class="keyword">transient</span> = <span class="keyword">new</span> <a class="code" href="classTMemFile.html">TMemFile</a>(filename,mess-&gt;<a class="code" href="classTBuffer.html#af22ffe394903a7d18505a0b60de63fe8">Buffer</a>() + mess-&gt;<a class="code" href="classTBuffer.html#af384bb472e426a724c6c0adfa0399746">Length</a>(),length);</div><div class="line">         mess-&gt;<a class="code" href="classTBuffer.html#aa73e88d4c85ee71a28947532692bfb68">SetBufferOffset</a>(mess-&gt;<a class="code" href="classTBuffer.html#af384bb472e426a724c6c0adfa0399746">Length</a>()+length);</div><div class="line">         merger.OutputFile(filename,<span class="stringliteral">&quot;UPDATE&quot;</span>);</div><div class="line">         merger.AddAdoptFile(<span class="keyword">transient</span>);</div><div class="line"></div><div class="line">         merger.PartialMerge(<a class="code" href="classTFileMerger.html#a8ea43dc0722ce413c7332584d8c3ef0faebb404406960bf33b1dc4b689e5a4ac9">TFileMerger::kAllIncremental</a>);</div><div class="line">         <span class="keyword">transient</span> = 0;</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mess-&gt;<a class="code" href="classTMessage.html#a3d6f99eeb25fe7cc5cbe1d54862e42b5">What</a>() == <a class="code" href="MessageTypes_8h.html#a2c9d6c5dbd9cd6158973ec7f1986f9b9a52cb40b3ca0a13457d86dbb71c0077fb">kMESS_OBJECT</a>) {</div><div class="line">         printf(<span class="stringliteral">&quot;got object of class: %s\n&quot;</span>, mess-&gt;<a class="code" href="classTMessage.html#afd7891b7f1876096253caaab14b6e700">GetClass</a>()-&gt;<a class="code" href="classTNamed.html#a42e3142d30b08fed1b07216d4a36b090">GetName</a>());</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         printf(<span class="stringliteral">&quot;*** Unexpected message ***\n&quot;</span>);</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keyword">delete</span> mess;</div><div class="line">   }</div><div class="line">}</div></div><!-- fragment --><dl class="section author"><dt>Author</dt><dd>Fons Rademakers </dd></dl>

<p class="definition">Definition in file <a class="el" href="fastMergeServer_8C_source.html">fastMergeServer.C</a>.</p>
</div></div><!-- contents -->
<html>
<body>
<div id="footer" style="background-color:#E5EBF3;">
<small>
<img class="footer" src="rootlogo_s.gif" alt="root"/></a>
ROOT 6.18/03 - Reference Guide Generated on Thu Aug 29 2019 04:10:19 (GVA Time) using Doxygen 1.8.14.
</small>
</div>
</body>
</html>
