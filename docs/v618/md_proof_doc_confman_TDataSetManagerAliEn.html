<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>ROOT: A PROOF interface to the AliEn file catalog</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ROOT.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table bgcolor="#346295" cellspacing="0" cellpadding="0">
  <tr>
    <td> <img style="height:90px" alt="Logo" src="rootlogo.gif"/> </td>
    <td valign="middle" style="color: #FFFFFF" nowrap="nowrap"><font size="6">ROOT</font> &#160; 6.18/03 <br> Reference Guide </td>
    <td style="width:100%"> </td>
  </tr>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">A PROOF interface to the AliEn file catalog </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview </h2>
<p>Datasets have been invented to provide PROOF users a cleaner access to sets of uniform data: each dataset has a name which helps identifying the kind of data stored, plus some meta-information, such as:</p>
<ul>
<li>default tree name</li>
<li>number of events in the default tree</li>
<li>file size</li>
<li>integrity information: <em>is my file corrupted?</em></li>
<li>locality information: <em>is my remote file available on a local storage?</em></li>
</ul>
<p>Datasets are also used by the <a href="http://afdsmgrd.googlecode.com/">staging daemon afdsmgrd</a> to trigger data staging, <em>i.e.</em> to request some data from being transferred from a remote storage to the local analysis facility disks.</p>
<p>PROOF datasets are handled by the <em>dataset manager</em>, a generic catalog of datasets which has been historically implemented by the class <code><a class="el" href="classTDataSetManagerFile.html">TDataSetManagerFile</a></code>, which stored each dataset inside a <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> file.</p>
<p>This dataset manager has been conceived for a small *(i.e., hundreds)* number of datasets which reflected data stored on the local analysis facility disks. As the PROOF analysis model became popular in ALICE, the number of datasets grew posing many problems.</p>
<ul>
<li>To give the possibility to process remote data, current datasets mimick file catalog functionalities by including also lists of files currently not staged on the local analysis facility.</li>
<li>Since users can create their own datasets, in many cases containing duplicate data, it has become demanding to provide maintenance and support.</li>
<li>Locality information in datasets is static: this means that, if a file gets deleted from a disk, the corresponding dataset(s) must be synchronized manually.</li>
</ul>
<h3>An interface to the AliEn file catalog</h3>
<p>The new <code><a class="el" href="classTDataSetManagerAliEn.html">TDataSetManagerAliEn</a></code> class is a new dataset manager which acts as an intermediate layer between PROOF datasets and the AliEn file catalog.</p>
<p>Dataset names do not represent any longer a static list of files: instead, it represents a <b>query string</b> to the AliEn file catalog that creates a dataset dynamically.</p>
<p><b>Locality information</b> is also filled on the fly by contacting the local file server: for instance, in case a <em>xrootd</em> pool of disks is used, fresh online information along with the exact host (endpoint) where each file is located is provided dynamically in a reasonable amount of time.</p>
<p>Both file catalog queries and locality information are cached on <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> files: cache is shared between users and its expiration time is configurable.</p>
<p>Since dataset information is now volatile, a separate and more straightforward method for issuing staging requests has also been provided.</p>
<h2>Configuration </h2>
<h3>PROOF</h3>
<p>Using the new dataset manager requires the <code>xpd.datasetsrc</code> directive in the xproofd configuration file: </p><pre class="fragment">xpd.datasetsrc alien cache:/path/to/dataset/cache urltemplate:http://myserver:1234/data&lt;path&gt; cacheexpiresecs:86400
</pre><p>alien : Tells PROOF that the dataset manager is the AliEn interface (as opposed to <code>file</code>).</p>
<p>cache : Specify a path <em>on the local filesystem</em> of the host running user's PROOF master.</p>
<p>&gt; This path is not a URL but just a local path. Moreover, the path &gt; must be visible from the host that will run each user's master, &gt; since a separate dataset manager instance is created per user.</p>
<p>&gt; If the cache directory does not exist, it is created, if possible, &gt; with open permissions (<code>rwxrwxrwx</code>). On a production environment &gt; it is advisable to create the cache directory manually beforehand &gt; with the same permissions.</p>
<p>urltemplate : Template used for translating between an <code>alien://</code> URL and the local storage's URL.</p>
<p><code>&lt;path&gt;</code> is written literally and will be substituted with the full AliEn path without the protocol.</p>
<p>&gt; An example on how URL translation works: &gt; &gt; - Template URL: &gt; &gt; root://alice-caf.cern.ch/&lt;path&gt; &gt; &gt; - Source URL: &gt; &gt; alien:///alice/data/2012/LHC12b/000178209/ESDs/pass1/12000178209061.17/AliESDs.root &gt; &gt; - Resulting URL: &gt; &gt; root://alice-caf.cern.ch//alice/data/2012/LHC12b/000178209/ESDs/pass1/12000178209061.17/AliESDs.root &gt; cacheexpiresecs : Number of seconds before cached information is considered expired and refetched *(e.g., 86400 for one day)*.</p>
<h3>PROOF-Lite</h3>
<p>One of the advantages of such a dynamic AliEn catalog interface is that it is possible to use it with PROOF-Lite.</p>
<p>By default, PROOF-Lite creates on the client session (which acts as a master as well) a file-based dataset manager. To enable the AliEn dataset manager in a PROOF-Lite session, run:</p>
<div class="fragment"><div class="line">gEnv-&gt;SetValue(&quot;Proof.DataSetManager&quot;,</div><div class="line">  &quot;alien cache:/path/to/dataset/cache &quot;</div><div class="line">  &quot;urltemplate:root://alice-caf.cern.ch/&lt;path&gt; &quot;</div><div class="line">  &quot;cacheexpiresecs:86400&quot;);</div><div class="line">TProof::Open(&quot;&quot;);</div></div><!-- fragment --><p>where the parameters meaning has been described in the previous section.</p>
<blockquote class="doxtable">
<p>Please note that the environment must be set <b>before</b> opening the PROOF-Lite session! </p>
</blockquote>
<h2>Usage </h2>
<p>The new dataset manager is backwards-compatible with the legacy interface: each time you want to process or obtain a dataset, instead of specifying a string containing a dataset name you will specify a query string to the file catalog.</p>
<h3>Query string format</h3>
<p>The query string is the string you will use in place of the dataset name. It does not correspond to a static dataset: instead it represents a virtual dataset whose information is filled in on the fly.</p>
<p>There are two different formats you can use:</p>
<ul>
<li>specify data features (such as period and run numbers) for <b>official data or Monte Carlo</b></li>
<li>specify the <b>AliEn find</b> command parameters directly</li>
</ul>
<p>In the query string it is also possible to specify if you want to process data from AliEn, only staged data or data from AliEn in "cache
mode".</p>
<h4>Official data and Monte Carlo format</h4>
<p>These are the string formats to be used respectively for official data and official Monte Carlo productions: </p><pre class="fragment">Data;Period=&lt;LHCPERIOD&gt;;Variant=[ESDs|AODXXX];Run=&lt;RUNLIST&gt;;Pass=&lt;PASS&gt;

Sim;Period=&lt;LHCPERIOD&gt;;Variant=[ESDs|AODXXX];Run=&lt;RUNLIST&gt;;
</pre><p>Period : The LHC period. </p><pre class="fragment">Example of valid values: `LHC10h`, `LHC11h_2`, `LHC11f_Technical`
</pre><p>Variant : Data variant, which might be <code>ESDs</code> (or <code>ESD</code>) for ESDs and <code>AODXXX</code> for AODs corresponding to the <em>XXX</em> set.</p>
<p>Example of valid values: <code>ESDs</code>, <code>AOD073</code>, <code>AOD086</code></p>
<p>Run : Runs to be processed, in the form of a single run (<code>130831</code>), an inclusive range (<code>130831-130833</code>), or a list of runs and/or ranges (<code>130831-130835,130840,130842</code>).</p>
<p>Duplicate runs are automatically removed, so in case you specify <code>130831-130835,130833</code> run number 130833 will be processed only once.</p>
<p>Pass *(only for data, not for Monte Carlo)* : The pass number or name. In case you specify only a number <code>X</code>, it will be expanded to <code>passX</code>.</p>
<p>Example of valid values: <code>1</code>, <code>pass1</code>, <code>pass2</code>, <code>cpass1_muon</code></p>
<p>This is an example of a full valid string: </p><pre class="fragment">Data;Period=LHC10h;Variant=AOD086;Run=130831-130833;Pass=pass1
</pre><h4>AliEn find format</h4>
<p>Whenever a user would like to process data which has not been produced officially, or whose directory structure in the AliEn file catalog is non-standard, an interface to the AliEn shell's <code>find</code> command is provided.</p>
<p>This is the command format: </p><pre class="fragment">Find;BasePath=&lt;BASEPATH&gt;;FileName=&lt;FILENAME&gt;;Anchor=&lt;ANCHOR&gt;;TreeName=&lt;TREENAME&gt;;Regexp=&lt;REGEXP&gt;
</pre><p>Parameters <code>BasePath</code> and <code>FileName</code> are passed as-is to the AliEn <a href="http://alien2.cern.ch/index.php?option=com_content&amp;view=article&amp;id=53&amp;Itemid=99#Searching_for_files">find command</a>, and are mandatory.</p>
<p>Parameters <code>Anchor</code>, <code>TreeName</code> and <code>Regexp</code> are optional.</p>
<p>Here's a detailed description of the parameters.</p>
<p>BasePath : Start search under the specified path on the AliEn file catalog. </p><pre class="fragment">Jolly characters are supported: the asterisk (`*`) and the
percentage sign (`%`) are interchangeable.

Examples of valid values are:

    /alice/data/2010/LHC10h/000123456/*.*
    /alice/cern.ch/user/d/dummy/my_pp_production/%.%
</pre><p>FileName : File name to look for. </p><pre class="fragment">Examples of valid values are: `root_archive.zip`, `aod_archive.zip`,
`custom_archive.zip`, `AliAOD.root.
</pre><p>Anchor *(optional)* : In case <code>FileName</code> is a zip archive, the anchor is the name of a <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> file inside the archive to point to.</p>
<p>Examples of valid values are: <code>AliAOD.root</code>, <code>AliESDs.root</code>, <code>MyRootFile.root</code>.</p>
<p>&gt; Using the AliEn file catalog it is possible to point directly to a &gt; <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> file stored in an archive without using the anchor. &gt; &gt; There is however a substantial difference in how data is &gt; retrieved, especially during staging: auxiliary <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> files &gt; *(friends)* are stored inside the archive along with the "main" &gt; file, so that when you use the archive as <code>FileName</code> with the &gt; proper <code>Anchor</code> you are still referencing to the same file, but &gt; you are giving instructions of downloading the archive. &gt; &gt; Using the <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> file name directly must be done in very special &gt; cases (<em>i.e.</em>, to save space) and only when one is completely sure &gt; that no external files in the archive are required for analysis.</p>
<p>TreeName *(optional)* : Name of each file's default tree. </p><pre class="fragment">Examples of valid values are: `/aodTree`, `/esdTree`, `/myCustomTree`,
`/TheDirectory/TheTree`.
</pre><p>Regexp *(optional)* : Additional extended regular expression applied after find command is run, to fine-grain search results.</p>
<p>Only <code>alien://</code> paths matching the regular expression are considered, others are discarded.</p>
<p>Examples of valid values are: </p><pre class="fragment">/[0-9]{6}/[0-9]{3,4}
\.root$
</pre><p>&gt; <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> class &gt; <a href="http://root.cern.ch/root/html/TPMERegexp.html">TPMERegexp</a> is &gt; used to perform regular expression matching.</p>
<p>Example of an AliEn raw find dataset string: </p><pre class="fragment">Find;BasePath=/alice/data/2010/LHC10h/000139505/ESDs/pass1/*.*;FileName=root_archive.zip;Anchor=AliESDs.root
</pre><h4>Data access modes</h4>
<p>It is possible to append to the format string the <code>Mode</code> specifier that affects the way URLs are generated. </p><pre class="fragment">Mode=[local|remote|cache]
</pre><p>This parameter is optional and defaults to <code>local</code>. Description of each possible value follows:</p>
<p>local : Local storage is checked for the presence of data you requested. Output URLs will be relative to your local storage. Also, locality information *(i.e., is your file staged?)* is filled.</p>
<p>If you run a PROOF analysis on a dataset with this mode specified, only data marked as "staged" will be processed.</p>
<p>This method is the preferred one, since it does not overload the remote storage, and it enables users to process partially-staged datasets, or partially-reconstructed runs, without the need to manually update static datasets.</p>
<p>&gt; This is the default if no mode is specified, and it is also the &gt; most efficient one. &gt; &gt; Despite it might take some time (up to a couple of minutes to &gt; locate ~4000 files), returned information is always reliable &gt; (because it's dynamic) and speeds up analysis (because analysis &gt; will always be run only on files having local copies). &gt; &gt; Moreover this information is cached for a configurable period of &gt; time, so that subsequent calls to the same dataset will be faster.</p>
<p>remote : Only AliEn URLs are returned. </p><pre class="fragment">A PROOF analysis run on a dataset with this mode specified will
always obtain data from a remote storage, according to the AliEn
file catalog.

&gt; Tasks run on remote data are usually much slower than using local
&gt; storage.
</pre><p>cache : URLs pointing to local copies of files are returned, but does not check whether the file is locally present or not.</p>
<p>If local storage is configured for retrieving from AliEn files that are not available locally (which is the case of xrootd with vMSS), then data will be downloaded <em>while analysis is running</em>.</p>
<p>It is called <em>cache mode</em> because it treats the local storage as a cache for the remote storage.</p>
<p>&gt; This mode is usually very slow on a busy analysis facility since &gt; retrieving data in real time without any kind of scheduling is &gt; inefficient. It also conflicts with the preferred method, which is &gt; to stage data asynchronously using the <a href="http://afdsmgrd.googlecode.com/">stager &gt; daemon</a>.</p>
<h4>Force cache refresh</h4>
<p>If the cached information for a certain AliEn file catalog query is wrong, it is possible to force querying the catalog again by using the keyword <code>ForceUpdate</code>: </p><pre class="fragment">Data;ForceUpdate;Period=LHC10h;Variant=AOD086;Run=130831-130833;Pass=pass1
</pre><h3>Staging requests</h3>
<p>Issuing staging requests and keeping track of them requires an auxiliary database that can be read and updated by the <a href="http://afdsmgrd.googlecode.com/">data stager daemon</a>.</p>
<p>Whenever a staging request is issued, a <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> file containing the dataset is saved in a special directory on the master's filesystem, monitored by the file stager.</p>
<h4>PROOF configuration</h4>
<p>In the xproofd configuration file, there is a directive to specify the directory used as repository for staging requests: </p><pre class="fragment">xpd.stagereqrepo [dir:]/path/to/local/directory
</pre><blockquote class="doxtable">
<p>The literal <code>dir:</code> prefix is optional. </p>
</blockquote>
<p>This directive is shared between PROOF and the stager daemon, so that the same configuration file can be used for both.</p>
<p>Permissions on this directory must be kept open.</p>
<blockquote class="doxtable">
<p>Versions of the stager daemon prior to v1.0.7 do not support open permissions and the staging repository directive. </p>
</blockquote>
<h4>Request and monitor staging</h4>
<p>Staging requests and monitoring can be done from within a PROOF session.</p>
<p><code>gProof-&gt;RequestStagingDataSet("QueryString")</code> : Requests staging of the dataset specified via the query string. </p><pre class="fragment">Staging request is honored if the stager daemon is running.

&gt; In order to avoid requesting to stage undesired data, it is
&gt; advisable to check in advance the results of your query string:
&gt;
&gt; `gProof-&gt;ShowDataSet("QueryString")`
</pre><p><code>TProof-&gt;ShowStagingStatusDataSet("QueryString"[, "opts"])</code> : Shows progress status of a previously given staging request with data specified by the query string.</p>
<p>Options are optional, and passed as-is to the <code><a class="el" href="namespaceROOT_1_1Math_1_1IntegOptionsUtil.html#ab6ed98cef4968e1f965c6ce7ac8b72ab">Print()</a></code> method.</p>
<p>&gt; It is possible to show all the files marked as corrupted by the &gt; daemon: &gt; &gt; gProof-&gt;ShowStagingStatusDataSet("QueryString", "C") &gt; &gt; Or all the files successfully staged and not corrupted: &gt; &gt; gProof-&gt;ShowStagingStatusDataSet("QueryString", "Sc")</p>
<p><code>gProof-&gt;GetStagingStatusDataSet("QueryString")</code> : Gets a <code><a class="el" href="classTFileCollection.html" title="Class that contains a list of TFileInfo&#39;s and accumulated meta data information about its entries...">TFileCollection</a></code> containing information on the staging request specified by the query string.</p>
<p>Works exactly like <code>ShowStagingStatusDataSet()</code> but returns an object instead of displaying information on the screen.</p>
<p><code>gProof-&gt;CancelStagingDataSet("QueryString")</code> : Removes a dataset from the list of staging requests. Datasets used as staging requests are usually removed automatically by the staging daemon if everything went right, so this command is used mostly to purge a completed staging request when it has some corrupted files. </p>
</div></div><!-- contents -->
<html>
<body>
<div id="footer" style="background-color:#E5EBF3;">
<small>
<img class="footer" src="rootlogo_s.gif" alt="root"/></a>
ROOT 6.18/03 - Reference Guide Generated on Thu Aug 29 2019 04:10:40 (GVA Time) using Doxygen 1.8.14.
</small>
</div>
</body>
</html>
