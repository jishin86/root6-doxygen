<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>ROOT: tutorials/net/parallelMergeServer.C File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ROOT.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table bgcolor="#346295" cellspacing="0" cellpadding="0">
  <tr>
    <td> <img style="height:90px" alt="Logo" src="rootlogo.gif"/> </td>
    <td valign="middle" style="color: #FFFFFF" nowrap="nowrap"><font size="6">ROOT</font> &#160; 6.18/03 <br> Reference Guide </td>
    <td style="width:100%"> </td>
  </tr>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_0d353d24d0afa59909efab6593124f6d.html">tutorials</a></li><li class="navelem"><a class="el" href="dir_bf1f374b06ae8970b3ffa8970c4657c3.html">net</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">parallelMergeServer.C File Reference<div class="ingroups"><a class="el" href="group__Tutorials.html">Tutorials</a> &raquo; <a class="el" href="group__tutorial__net.html">Net tutorials</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This script shows how to make a simple iterative server that can accept connections while handling currently open connections. </p>
<p>Compare this script to <a class="el" href="hserv_8C.html" title="Server program which waits for two clients to connect. ">hserv.C</a> that blocks on accept. In this script a server socket is created and added to a monitor. A monitor object is used to monitor connection requests on the server socket. After accepting the connection the new socket is added to the monitor and immediately ready for use. Once two connections are accepted the server socket is removed from the monitor and closed. The monitor continues monitoring the sockets.</p>
<p>To run this demo do the following:</p><ul>
<li>Open three windows</li>
<li>Start <a class="el" href="namespaceROOT.html" title="Namespace for new ROOT classes and functions. ">ROOT</a> in all three windows</li>
<li>Execute in the first window: .x <a class="el" href="hserv2_8C.html" title="This script shows how to make a simple iterative server that can accept connections while handling cu...">hserv2.C</a></li>
<li>Execute in the second and third windows: .x <a class="el" href="hclient_8C.html" title="Client program which creates and fills a histogram. ">hclient.C</a></li>
</ul>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TMessage_8h.html">TMessage.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TBenchmark_8h.html">TBenchmark.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TSocket_8h.html">TSocket.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TH2_8h.html">TH2.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TTree_8h.html">TTree.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TMemFile_8h.html">TMemFile.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TRandom_8h.html">TRandom.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TError_8h.html">TError.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TFileMerger_8h.html">TFileMerger.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TServerSocket_8h.html">TServerSocket.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TPad_8h.html">TPad.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TCanvas_8h.html">TCanvas.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TMonitor_8h.html">TMonitor.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TFileCacheWrite_8h.html">TFileCacheWrite.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TSystem_8h.html">TSystem.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="THashTable_8h.html">THashTable.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TMath_8h.html">TMath.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TTimeStamp_8h.html">TTimeStamp.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> kIncremental = 0;</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> kReplaceImmediately = 1;</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> kReplaceWait = 2;</div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="TKey_8h.html">TKey.h</a>&quot;</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> R__NeedInitialMerge(<a class="code" href="classTDirectory.html">TDirectory</a> *dir)</div><div class="line">{</div><div class="line"></div><div class="line">   <span class="keywordflow">if</span> (dir==0) <span class="keywordflow">return</span> <a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>;</div><div class="line"></div><div class="line">   <a class="code" href="classTIter.html">TIter</a> nextkey(dir-&gt;<a class="code" href="classTDirectory.html#a8f240474c13086907c6297f566f45f4f">GetListOfKeys</a>());</div><div class="line">   <a class="code" href="classTKey.html">TKey</a> *key;</div><div class="line">   <span class="keywordflow">while</span>( (key = (<a class="code" href="classTKey.html">TKey</a>*)nextkey()) ) {</div><div class="line">      <a class="code" href="classTClass.html">TClass</a> *cl = <a class="code" href="classTClass.html#a4a5443bb08096e49cb6b1bce1d07139d">TClass::GetClass</a>(key-&gt;GetClassName());</div><div class="line">      <span class="keywordflow">if</span> (cl-&gt;<a class="code" href="classTClass.html#aed45f7594297139da32ef0f08db74272">InheritsFrom</a>(<a class="code" href="Class_8C.html#adcfdef0a91f6e5dcab5b9c14cf964be5">TDirectory::Class</a>())) {</div><div class="line">         <a class="code" href="classTDirectory.html">TDirectory</a> *subdir = (<a class="code" href="classTDirectory.html">TDirectory</a> *)dir-&gt;<a class="code" href="classTDirectory.html#a1a894a8bb78b65cfab71426b839e9adc">GetList</a>()-&gt;<a class="code" href="classTList.html#a85c8734ab131c0db5f68c724e47496a7">FindObject</a>(key-&gt;GetName());</div><div class="line">         <span class="keywordflow">if</span> (!subdir) {</div><div class="line">            subdir = (<a class="code" href="classTDirectory.html">TDirectory</a> *)key-&gt;ReadObj();</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (R__NeedInitialMerge(subdir)) {</div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <span class="keywordflow">if</span> (0 != cl-&gt;<a class="code" href="classTClass.html#a8af87de4c0a208aae3d8acfaa7796324">GetResetAfterMerge</a>()) {</div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>;</div><div class="line">         }</div><div class="line">      }</div><div class="line">   }</div><div class="line">   <span class="keywordflow">return</span> <a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> R__DeleteObject(<a class="code" href="classTDirectory.html">TDirectory</a> *dir, <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> withReset)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (dir==0) <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">   <a class="code" href="classTIter.html">TIter</a> nextkey(dir-&gt;<a class="code" href="classTDirectory.html#a8f240474c13086907c6297f566f45f4f">GetListOfKeys</a>());</div><div class="line">   <a class="code" href="classTKey.html">TKey</a> *key;</div><div class="line">   <span class="keywordflow">while</span>( (key = (<a class="code" href="classTKey.html">TKey</a>*)nextkey()) ) {</div><div class="line">      <a class="code" href="classTClass.html">TClass</a> *cl = <a class="code" href="classTClass.html#a4a5443bb08096e49cb6b1bce1d07139d">TClass::GetClass</a>(key-&gt;GetClassName());</div><div class="line">      <span class="keywordflow">if</span> (cl-&gt;<a class="code" href="classTClass.html#aed45f7594297139da32ef0f08db74272">InheritsFrom</a>(<a class="code" href="Class_8C.html#adcfdef0a91f6e5dcab5b9c14cf964be5">TDirectory::Class</a>())) {</div><div class="line">         <a class="code" href="classTDirectory.html">TDirectory</a> *subdir = (<a class="code" href="classTDirectory.html">TDirectory</a> *)dir-&gt;<a class="code" href="classTDirectory.html#a1a894a8bb78b65cfab71426b839e9adc">GetList</a>()-&gt;<a class="code" href="classTList.html#a85c8734ab131c0db5f68c724e47496a7">FindObject</a>(key-&gt;GetName());</div><div class="line">         <span class="keywordflow">if</span> (!subdir) {</div><div class="line">            subdir = (<a class="code" href="classTDirectory.html">TDirectory</a> *)key-&gt;ReadObj();</div><div class="line">         }</div><div class="line">         R__DeleteObject(subdir,withReset);</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> todelete = <a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>;</div><div class="line">         <span class="keywordflow">if</span> (withReset) {</div><div class="line">            todelete = (0 != cl-&gt;<a class="code" href="classTClass.html#a8af87de4c0a208aae3d8acfaa7796324">GetResetAfterMerge</a>());</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            todelete = (0 ==  cl-&gt;<a class="code" href="classTClass.html#a8af87de4c0a208aae3d8acfaa7796324">GetResetAfterMerge</a>());</div><div class="line">         }</div><div class="line">         <span class="keywordflow">if</span> (todelete) {</div><div class="line">            key-&gt;Delete();</div><div class="line">            dir-&gt;<a class="code" href="classTDirectory.html#a8f240474c13086907c6297f566f45f4f">GetListOfKeys</a>()-&gt;<a class="code" href="classTList.html#a3026e979d86376d2f362044d5a94c71b">Remove</a>(key);</div><div class="line">            <span class="keyword">delete</span> key;</div><div class="line">         }</div><div class="line">      }</div><div class="line">   }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> R__MigrateKey(<a class="code" href="classTDirectory.html">TDirectory</a> *destination, <a class="code" href="classTDirectory.html">TDirectory</a> *source)</div><div class="line">{</div><div class="line">   <span class="keywordflow">if</span> (destination==0 || source==0) <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">   <a class="code" href="classTIter.html">TIter</a> nextkey(source-&gt;<a class="code" href="classTDirectory.html#a8f240474c13086907c6297f566f45f4f">GetListOfKeys</a>());</div><div class="line">   <a class="code" href="classTKey.html">TKey</a> *key;</div><div class="line">   <span class="keywordflow">while</span>( (key = (<a class="code" href="classTKey.html">TKey</a>*)nextkey()) ) {</div><div class="line">      <a class="code" href="classTClass.html">TClass</a> *cl = <a class="code" href="classTClass.html#a4a5443bb08096e49cb6b1bce1d07139d">TClass::GetClass</a>(key-&gt;GetClassName());</div><div class="line">      <span class="keywordflow">if</span> (cl-&gt;<a class="code" href="classTClass.html#aed45f7594297139da32ef0f08db74272">InheritsFrom</a>(<a class="code" href="Class_8C.html#adcfdef0a91f6e5dcab5b9c14cf964be5">TDirectory::Class</a>())) {</div><div class="line">         <a class="code" href="classTDirectory.html">TDirectory</a> *source_subdir = (<a class="code" href="classTDirectory.html">TDirectory</a> *)source-&gt;<a class="code" href="classTDirectory.html#a1a894a8bb78b65cfab71426b839e9adc">GetList</a>()-&gt;<a class="code" href="classTList.html#a85c8734ab131c0db5f68c724e47496a7">FindObject</a>(key-&gt;GetName());</div><div class="line">         <span class="keywordflow">if</span> (!source_subdir) {</div><div class="line">            source_subdir = (<a class="code" href="classTDirectory.html">TDirectory</a> *)key-&gt;ReadObj();</div><div class="line">         }</div><div class="line">         <a class="code" href="classTDirectory.html">TDirectory</a> *destination_subdir = destination-&gt;<a class="code" href="classTDirectory.html#a1f77f7d3e909d21d24e53e8e9ebbc6b8">GetDirectory</a>(key-&gt;GetName());</div><div class="line">         <span class="keywordflow">if</span> (!destination_subdir) {</div><div class="line">            destination_subdir = destination-&gt;<a class="code" href="classTDirectory.html#aefc863f608016f7d05ab1a6d4ba5688d">mkdir</a>(key-&gt;GetName());</div><div class="line">         }</div><div class="line">         R__MigrateKey(destination,source);</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         <a class="code" href="classTKey.html">TKey</a> *oldkey = destination-&gt;<a class="code" href="classTDirectory.html#a055c04e4c71d7abc58aab316fbdd4bf0">GetKey</a>(key-&gt;GetName());</div><div class="line">         <span class="keywordflow">if</span> (oldkey) {</div><div class="line">            oldkey-&gt;<a class="code" href="classTKey.html#a2709814d16134fd786558765e7e6af75">Delete</a>();</div><div class="line">            <span class="keyword">delete</span> oldkey;</div><div class="line">         }</div><div class="line">         <a class="code" href="classTKey.html">TKey</a> *newkey = <span class="keyword">new</span> <a class="code" href="classTKey.html">TKey</a>(destination,*key,0 <span class="comment">/* pidoffset */</span>); <span class="comment">// a priori the file are from the same client ..</span></div><div class="line">         destination-&gt;<a class="code" href="classTDirectory.html#a68e6fdc7cc3cc792d8b57010c5fd4a2d">GetFile</a>()-&gt;<a class="code" href="classTFile.html#a8288004f2399fd4467daac62e965fbda">SumBuffer</a>(newkey-&gt;<a class="code" href="classTKey.html#a6078015f47c1c6f085f5f26617beb221">GetObjlen</a>());</div><div class="line">         newkey-&gt;<a class="code" href="classTKey.html#a89b1d03952494295fba89e2c7c26364f">WriteFile</a>(0);</div><div class="line">         <span class="keywordflow">if</span> (destination-&gt;<a class="code" href="classTDirectory.html#a68e6fdc7cc3cc792d8b57010c5fd4a2d">GetFile</a>()-&gt;<a class="code" href="classTObject.html#a38faf62b72bcca7178255935b7ff9ef0">TestBit</a>(<a class="code" href="classTFile.html#ae82abd48570a83d8aecb2af32eaa324eae57ccaeb05a61fe448b399c8e25551bf">TFile::kWriteError</a>)) {</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">         }</div><div class="line">      }</div><div class="line">   }</div><div class="line">   destination-&gt;<a class="code" href="classTDirectory.html#aa00045a5933aa262053443614b6e4941">SaveSelf</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span>ClientInfo</div><div class="line">{</div><div class="line">   <a class="code" href="classTFile.html">TFile</a>      *fFile;      <span class="comment">// This object does *not* own the file, it will be own by the owner of the ClientInfo.</span></div><div class="line">   <a class="code" href="classTString.html">TString</a>    fLocalName;</div><div class="line">   <a class="code" href="RtypesCore_8h.html#a7c1bc4939263cb6c0f48e434d77ac258">UInt_t</a>     fContactsCount;</div><div class="line">   <a class="code" href="classTTimeStamp.html">TTimeStamp</a> fLastContact;</div><div class="line">   <a class="code" href="RtypesCore_8h.html#ab9b5334647b78ec4256db251e3ae1fc6">Double_t</a>   fTimeSincePrevContact;</div><div class="line"></div><div class="line">   ClientInfo() : fFile(0), fLocalName(), fContactsCount(0), fTimeSincePrevContact(0) {}</div><div class="line">   ClientInfo(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <a class="code" href="RtypesCore_8h.html#a7c1bc4939263cb6c0f48e434d77ac258">UInt_t</a> clientId) : fFile(0), fContactsCount(0), fTimeSincePrevContact(0) {</div><div class="line">      fLocalName.<a class="code" href="classTString.html#aeb44d6183d8b1f1b7090dbd3c93f5e39">Form</a>(<span class="stringliteral">&quot;%s-%d-%d&quot;</span>,filename,clientId,<a class="code" href="TSystem_8h.html#ab7182c9ab5a9236e2bc1ed8b3fcb045f">gSystem</a>-&gt;<a class="code" href="classTSystem.html#a455fbf7bfc65e0d2fa0643701d9bac6d">GetPid</a>());</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordtype">void</span> Set(<a class="code" href="classTFile.html">TFile</a> *<a class="code" href="namespacefile.html">file</a>)</div><div class="line">   {</div><div class="line">      <span class="comment">// Register the new file as coming from this client.</span></div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespacefile.html">file</a> != fFile) {</div><div class="line">         <span class="comment">// We need to keep any of the keys from the previous file that</span></div><div class="line">         <span class="comment">// are not in the new file.</span></div><div class="line">         <span class="keywordflow">if</span> (fFile) {</div><div class="line">            R__MigrateKey(fFile,<a class="code" href="namespacefile.html">file</a>);</div><div class="line">            <span class="comment">// delete the previous memory file (if any)</span></div><div class="line">            <span class="keyword">delete</span> <a class="code" href="namespacefile.html">file</a>;</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            fFile = <a class="code" href="namespacefile.html">file</a>;</div><div class="line">         }</div><div class="line">      }</div><div class="line">      <a class="code" href="classTTimeStamp.html">TTimeStamp</a> now;</div><div class="line">      fTimeSincePrevContact = now.<a class="code" href="classTTimeStamp.html#ae157f092aca813d07e1091cd14bb82b1">AsDouble</a>() - fLastContact.<a class="code" href="classTTimeStamp.html#ae157f092aca813d07e1091cd14bb82b1">AsDouble</a>();</div><div class="line">      fLastContact = now;</div><div class="line">      ++fContactsCount;</div><div class="line">   }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span>ParallelFileMerger : <span class="keyword">public</span> <a class="code" href="classTObject.html">TObject</a></div><div class="line">{</div><div class="line">   <span class="keyword">typedef</span> std::vector&lt;ClientInfo&gt; ClientColl_t;</div><div class="line"></div><div class="line">   <a class="code" href="classTString.html">TString</a>       fFilename;</div><div class="line">   <a class="code" href="classTBits.html">TBits</a>         fClientsContact;       <span class="comment">//</span></div><div class="line">   <a class="code" href="RtypesCore_8h.html#a7c1bc4939263cb6c0f48e434d77ac258">UInt_t</a>        fNClientsContact;      <span class="comment">//</span></div><div class="line">   ClientColl_t  fClients;</div><div class="line">   <a class="code" href="classTTimeStamp.html">TTimeStamp</a>    fLastMerge;</div><div class="line">   <a class="code" href="classTFileMerger.html">TFileMerger</a>   fMerger;</div><div class="line"></div><div class="line">   ParallelFileMerger(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> writeCache = <a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>) : fFilename(filename), fNClientsContact(0), fMerger(<a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>,<a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>)</div><div class="line">   {</div><div class="line">      <span class="comment">// Default constructor.</span></div><div class="line"></div><div class="line">      fMerger.<a class="code" href="classTFileMerger.html#a7870512f55895368366a910f257c1f25">SetPrintLevel</a>(0);</div><div class="line">      fMerger.<a class="code" href="classTFileMerger.html#a107416b7da987bc2292e730e26798be1">OutputFile</a>(filename,<span class="stringliteral">&quot;RECREATE&quot;</span>);</div><div class="line">      <span class="keywordflow">if</span> (writeCache) <span class="keyword">new</span> <a class="code" href="classTFileCacheWrite.html">TFileCacheWrite</a>(fMerger.<a class="code" href="classTFileMerger.html#a87ebce2ed15c6e934b2b98aa5ef370fd">GetOutputFile</a>(),32*1024*1024);</div><div class="line">   }</div><div class="line"></div><div class="line">   ~ParallelFileMerger()</div><div class="line">   {</div><div class="line">      <span class="comment">// Destructor.</span></div><div class="line"></div><div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> = 0 ; <a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> &lt; fClients.size(); ++<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line">         fprintf(stderr,<span class="stringliteral">&quot;Client %d reported %u times\n&quot;</span>,<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>,fClients[<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>].fContactsCount);</div><div class="line">      }</div><div class="line">      <span class="keywordflow">for</span>( ClientColl_t::iterator iter = fClients.begin();</div><div class="line">          iter != fClients.end();</div><div class="line">          ++iter)</div><div class="line">      {</div><div class="line">         <span class="keyword">delete</span> iter-&gt;fFile;</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="RtypesCore_8h.html#a7fb84b1ccbe52e994b2fd2bcf5874fb5">ULong_t</a>  <a class="code" href="classTObject.html#ae019bc9f6f5c15cb4a7cf6fbeedb75f5">Hash</a>()<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">      <span class="comment">// Return hash value for this object.</span></div><div class="line">      <span class="keywordflow">return</span> fFilename.<a class="code" href="classTString.html#aa5efc56ea058c6e445c6f95c85ec019a">Hash</a>();</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classTObject.html#a1d6abd2708ecd7578d7ff03c07037bd1">GetName</a>()<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">      <span class="comment">// Return the name of the object which is the name of the output file.</span></div><div class="line">      <span class="keywordflow">return</span> fFilename;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> InitialMerge(<a class="code" href="classTFile.html">TFile</a> *input)</div><div class="line">   {</div><div class="line">      <span class="comment">// Initial merge of the input to copy the resetable object (TTree) into the output</span></div><div class="line">      <span class="comment">// and remove them from the input file.</span></div><div class="line"></div><div class="line">      fMerger.<a class="code" href="classTFileMerger.html#a20a821acc11ca31dbe7a9df70c11ebfb">AddFile</a>(input);</div><div class="line"></div><div class="line">      <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> result = fMerger.<a class="code" href="classTFileMerger.html#ad51083b4d0fbd86ff058f0583e33a5b2">PartialMerge</a>(<a class="code" href="classTFileMerger.html#a8ea43dc0722ce413c7332584d8c3ef0fa77af3901d1515a61946a79669794c280">TFileMerger::kIncremental</a> | <a class="code" href="classTFileMerger.html#a8ea43dc0722ce413c7332584d8c3ef0fad4e0e3e80b6cfbba50d893ab950297a5">TFileMerger::kResetable</a>);</div><div class="line"></div><div class="line">      R__DeleteObject(input,<a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>);</div><div class="line">      <span class="keywordflow">return</span> result;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> Merge()</div><div class="line">   {</div><div class="line">      <span class="comment">// Merge the current inputs into the output file.</span></div><div class="line"></div><div class="line">      R__DeleteObject(fMerger.<a class="code" href="classTFileMerger.html#a87ebce2ed15c6e934b2b98aa5ef370fd">GetOutputFile</a>(),<a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>); <span class="comment">// Remove object that can *not* be incrementally merge and will *not* be reset by the client code.</span></div><div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> = 0 ; <a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> &lt; fClients.size(); ++<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line">         fMerger.<a class="code" href="classTFileMerger.html#a20a821acc11ca31dbe7a9df70c11ebfb">AddFile</a>(fClients[<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>].fFile);</div><div class="line">      }</div><div class="line">      <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> result = fMerger.<a class="code" href="classTFileMerger.html#ad51083b4d0fbd86ff058f0583e33a5b2">PartialMerge</a>(<a class="code" href="classTFileMerger.html#a8ea43dc0722ce413c7332584d8c3ef0faebb404406960bf33b1dc4b689e5a4ac9">TFileMerger::kAllIncremental</a>);</div><div class="line"></div><div class="line">      <span class="comment">// Remove any &#39;resetable&#39; object (like TTree) from the input file so that they will not</span></div><div class="line">      <span class="comment">// be re-merged.  Keep only the object that always need to be re-merged (Histograms).</span></div><div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> = 0 ; <a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> &lt; fClients.size(); ++<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line">         <span class="keywordflow">if</span> (fClients[<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>].fFile) {</div><div class="line">            R__DeleteObject(fClients[<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>].fFile,<a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>);</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <span class="comment">// We back up the file (probably due to memory constraint)</span></div><div class="line">            <a class="code" href="classTFile.html">TFile</a> *<a class="code" href="namespacefile.html">file</a> = <a class="code" href="classTFile.html#aec5f3fae0774aabfc615ebb4b00fe5e0">TFile::Open</a>(fClients[<a class="code" href="RSha256_8hxx.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>].fLocalName,<span class="stringliteral">&quot;UPDATE&quot;</span>);</div><div class="line">            R__DeleteObject(<a class="code" href="namespacefile.html">file</a>,<a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>); <span class="comment">// Remove object that can be incrementally merge and will be reset by the client code.</span></div><div class="line">            <a class="code" href="namespacefile.html">file</a>-&gt;Write();</div><div class="line">            <span class="keyword">delete</span> <a class="code" href="namespacefile.html">file</a>;</div><div class="line">         }</div><div class="line">      }</div><div class="line">      fLastMerge = <a class="code" href="classTTimeStamp.html">TTimeStamp</a>();</div><div class="line">      fNClientsContact = 0;</div><div class="line">      fClientsContact.<a class="code" href="classTBits.html#a1cf7c87da11ab4bb386ede1daecc5140">Clear</a>();</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> result;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> NeedFinalMerge()</div><div class="line">   {</div><div class="line">      <span class="comment">// Return true, if there is any data that has not been merged.</span></div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> fClientsContact.<a class="code" href="classTBits.html#a95f125b1f5bc3b518cf443689ea4c4f9">CountBits</a>() &gt; 0;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="RtypesCore_8h.html#aa101f564ac7b845ca31aec2fbc00ce97">Bool_t</a> NeedMerge(<a class="code" href="RtypesCore_8h.html#aeea98adf47c4604318761944f6780133">Float_t</a> clientThreshold)</div><div class="line">   {</div><div class="line">      <span class="comment">// Return true, if enough client have reported</span></div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (fClients.size()==0) {</div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="RtypesCore_8h.html#a7e568baf910535e8ffd438acb843434d">kFALSE</a>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="comment">// Calculate average and rms of the time between the last 2 contacts.</span></div><div class="line">      <a class="code" href="RtypesCore_8h.html#ab9b5334647b78ec4256db251e3ae1fc6">Double_t</a> <a class="code" href="tmva_2tmva_2src_2Factory_8cxx.html#a73e5b6a37db0af518793b45eba2bbe8e">sum</a> = 0;</div><div class="line">      <a class="code" href="RtypesCore_8h.html#ab9b5334647b78ec4256db251e3ae1fc6">Double_t</a> sum2 = 0;</div><div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="RSha256_8hxx.html#a63f410abde93141c9013b7d3f3971738">c</a> = 0 ; <a class="code" href="RSha256_8hxx.html#a63f410abde93141c9013b7d3f3971738">c</a> &lt; fClients.size(); ++<a class="code" href="RSha256_8hxx.html#a63f410abde93141c9013b7d3f3971738">c</a>) {</div><div class="line">         <a class="code" href="tmva_2tmva_2src_2Factory_8cxx.html#a73e5b6a37db0af518793b45eba2bbe8e">sum</a> += fClients[<a class="code" href="RSha256_8hxx.html#a63f410abde93141c9013b7d3f3971738">c</a>].fTimeSincePrevContact;</div><div class="line">         sum2 += fClients[<a class="code" href="RSha256_8hxx.html#a63f410abde93141c9013b7d3f3971738">c</a>].fTimeSincePrevContact*fClients[<a class="code" href="RSha256_8hxx.html#a63f410abde93141c9013b7d3f3971738">c</a>].fTimeSincePrevContact;</div><div class="line">      }</div><div class="line">      <a class="code" href="RtypesCore_8h.html#ab9b5334647b78ec4256db251e3ae1fc6">Double_t</a> avg = <a class="code" href="tmva_2tmva_2src_2Factory_8cxx.html#a73e5b6a37db0af518793b45eba2bbe8e">sum</a> / fClients.size();</div><div class="line">      <a class="code" href="RtypesCore_8h.html#ab9b5334647b78ec4256db251e3ae1fc6">Double_t</a> <a class="code" href="h1analysisProxy_8h.html#a351c2b9335dfcbe83de6eb9629c2a0e3">sigma</a> = sum2 ? <a class="code" href="namespaceTMath.html#a9ea900c956031cb12057acf7c322b0fa">TMath::Sqrt</a>( sum2 / fClients.size() - avg*avg) : 0;</div><div class="line">      <a class="code" href="RtypesCore_8h.html#ab9b5334647b78ec4256db251e3ae1fc6">Double_t</a> target = avg + 2*<a class="code" href="h1analysisProxy_8h.html#a351c2b9335dfcbe83de6eb9629c2a0e3">sigma</a>;</div><div class="line">      <a class="code" href="classTTimeStamp.html">TTimeStamp</a> now;</div><div class="line">      <span class="keywordflow">if</span> ( (now.<a class="code" href="classTTimeStamp.html#ae157f092aca813d07e1091cd14bb82b1">AsDouble</a>() - fLastMerge.<a class="code" href="classTTimeStamp.html#ae157f092aca813d07e1091cd14bb82b1">AsDouble</a>()) &gt; target) {</div><div class="line"><span class="comment">//         Float_t cut = clientThreshold * fClients.size();</span></div><div class="line"><span class="comment">//         if (!(fClientsContact.CountBits() &gt; cut )) {</span></div><div class="line"><span class="comment">//            for(unsigned int c = 0 ; c &lt; fClients.size(); ++c) {</span></div><div class="line"><span class="comment">//               fprintf(stderr,&quot;%d:%f &quot;,c,fClients[c].fTimeSincePrevContact);</span></div><div class="line"><span class="comment">//            }</span></div><div class="line"><span class="comment">//            fprintf(stderr,&quot;merge:%f avg:%f target:%f\n&quot;,(now.AsDouble() - fLastMerge.AsDouble()),avg,target);</span></div><div class="line"><span class="comment">//         }</span></div><div class="line">         <span class="keywordflow">return</span> <a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>;</div><div class="line">      }</div><div class="line">      <a class="code" href="RtypesCore_8h.html#aeea98adf47c4604318761944f6780133">Float_t</a> cut = clientThreshold * fClients.size();</div><div class="line">      <span class="keywordflow">return</span> fClientsContact.<a class="code" href="classTBits.html#a95f125b1f5bc3b518cf443689ea4c4f9">CountBits</a>() &gt; cut  || fNClientsContact &gt; 2*cut;</div><div class="line">   }</div><div class="line"></div><div class="line">   <span class="keywordtype">void</span> RegisterClient(<a class="code" href="RtypesCore_8h.html#a7c1bc4939263cb6c0f48e434d77ac258">UInt_t</a> clientId, <a class="code" href="classTFile.html">TFile</a> *<a class="code" href="namespacefile.html">file</a>)</div><div class="line">   {</div><div class="line">      <span class="comment">// Register that a client has sent a file.</span></div><div class="line"></div><div class="line">      ++fNClientsContact;</div><div class="line">      fClientsContact.<a class="code" href="classTBits.html#afe77da6904d2fb1236cbca6bb14b4b63">SetBitNumber</a>(clientId);</div><div class="line">      <span class="keywordflow">if</span> (fClients.size() &lt; clientId+1) {</div><div class="line">         fClients.push_back( ClientInfo(fFilename,clientId) );</div><div class="line">      }</div><div class="line">      fClients[clientId].Set(<a class="code" href="namespacefile.html">file</a>);</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="Rtypes_8h.html#a0f5f4feb8484fa7bec8adf82b6c3836b">ClassDef</a>(ParallelFileMerger,0);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> parallelMergeServer(<span class="keywordtype">bool</span> cache = <span class="keyword">false</span>) {</div><div class="line">   <span class="comment">// Open a server socket looking for connections on a named service or</span></div><div class="line">   <span class="comment">// on a specified port.</span></div><div class="line">   <span class="comment">//TServerSocket *ss = new TServerSocket(&quot;rootserv&quot;, kTRUE);</span></div><div class="line">   <a class="code" href="classTServerSocket.html">TServerSocket</a> *ss = <span class="keyword">new</span> <a class="code" href="classTServerSocket.html">TServerSocket</a>(1095, <a class="code" href="RtypesCore_8h.html#af2f51d30ccd86e85be3e3e69793a86ef">kTRUE</a>, 100);</div><div class="line">   <span class="keywordflow">if</span> (!ss-&gt;<a class="code" href="classTSocket.html#af05548498926e8ded5cb4e71c4c6c597">IsValid</a>()) {</div><div class="line">      <span class="keywordflow">return</span>;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="classTMonitor.html">TMonitor</a> *mon = <span class="keyword">new</span> <a class="code" href="classTMonitor.html">TMonitor</a>;</div><div class="line"></div><div class="line">   mon-&gt;<a class="code" href="classTMonitor.html#a631545e472cb7107d1949da432974b26">Add</a>(ss);</div><div class="line"></div><div class="line">   <a class="code" href="RtypesCore_8h.html#a7c1bc4939263cb6c0f48e434d77ac258">UInt_t</a> clientCount = 0;</div><div class="line">   <a class="code" href="RtypesCore_8h.html#a7c1bc4939263cb6c0f48e434d77ac258">UInt_t</a> clientIndex = 0;</div><div class="line"></div><div class="line">   <a class="code" href="classTHashTable.html">THashTable</a> mergers;</div><div class="line"></div><div class="line">   <span class="keyword">enum</span> StatusKind {</div><div class="line">      kStartConnection = 0,</div><div class="line">      kProtocol = 1,</div><div class="line"></div><div class="line">      kProtocolVersion = 1</div><div class="line">   };</div><div class="line"></div><div class="line">   printf(<span class="stringliteral">&quot;fastMergeServerHist ready to accept connections\n&quot;</span>);</div><div class="line">   <span class="keywordflow">while</span> (1) {</div><div class="line">      <a class="code" href="classTMessage.html">TMessage</a> *mess;</div><div class="line">      <a class="code" href="classTSocket.html">TSocket</a>  *<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>;</div><div class="line"></div><div class="line">      <span class="comment">// NOTE: this needs to be update to handle the case where the client</span></div><div class="line">      <span class="comment">// dies.</span></div><div class="line">      <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a> = mon-&gt;<a class="code" href="classTMonitor.html#a3dfb30e40f93faa98435ba52645254ce">Select</a>();</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;IsA() == <a class="code" href="Class_8C.html#adcfdef0a91f6e5dcab5b9c14cf964be5">TServerSocket::Class</a>()) {</div><div class="line">         <span class="keywordflow">if</span> (clientCount &gt; 100) {</div><div class="line">            printf(<span class="stringliteral">&quot;only accept 100 clients connections\n&quot;</span>);</div><div class="line">            mon-&gt;<a class="code" href="classTMonitor.html#ad4afa7b761bd0a132736cc0f8ce9c686">Remove</a>(ss);</div><div class="line">            ss-&gt;<a class="code" href="classTSocket.html#a6d73e219d72b1d9066cc1c9c1257e0f7">Close</a>();</div><div class="line">         } <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="classTSocket.html">TSocket</a> *client = ((<a class="code" href="classTServerSocket.html">TServerSocket</a> *)<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>)-&gt;Accept();</div><div class="line">            client-&gt;<a class="code" href="classTSocket.html#af6bbdf49e36b08535a8821ea128422db">Send</a>(clientIndex, kStartConnection);</div><div class="line">            client-&gt;<a class="code" href="classTSocket.html#af6bbdf49e36b08535a8821ea128422db">Send</a>(kProtocolVersion, kProtocol);</div><div class="line">            ++clientCount;</div><div class="line">            ++clientIndex;</div><div class="line">            mon-&gt;<a class="code" href="classTMonitor.html#a631545e472cb7107d1949da432974b26">Add</a>(client);</div><div class="line">            printf(<span class="stringliteral">&quot;Accept %d connections\n&quot;</span>,clientCount);</div><div class="line">         }</div><div class="line">         <span class="keywordflow">continue</span>;</div><div class="line">      }</div><div class="line"></div><div class="line">      <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;Recv(mess);</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (mess==0) {</div><div class="line">         <a class="code" href="TError_8h.html#a66cc228e173b5602f3733072c52266b0">Error</a>(<span class="stringliteral">&quot;fastMergeServer&quot;</span>,<span class="stringliteral">&quot;The client did not send a message\n&quot;</span>);</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mess-&gt;<a class="code" href="classTMessage.html#a3d6f99eeb25fe7cc5cbe1d54862e42b5">What</a>() == <a class="code" href="MessageTypes_8h.html#a2c9d6c5dbd9cd6158973ec7f1986f9b9a1e38fa0dd45a6674f10f7618f0ea8375">kMESS_STRING</a>) {</div><div class="line">         <span class="keywordtype">char</span> str[64];</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#ada28655f1bc1f194321160c6fe5cea22">ReadString</a>(str, 64);</div><div class="line">         printf(<span class="stringliteral">&quot;Client %d: %s\n&quot;</span>, clientCount, str);</div><div class="line">         mon-&gt;<a class="code" href="classTMonitor.html#ad4afa7b761bd0a132736cc0f8ce9c686">Remove</a>(<a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>);</div><div class="line">         printf(<span class="stringliteral">&quot;Client %d: bytes recv = %d, bytes sent = %d\n&quot;</span>, clientCount, <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;GetBytesRecv(),</div><div class="line">                <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;GetBytesSent());</div><div class="line">         <a class="code" href="namespaceTGeant4Unit.html#a5d450e80998065902b102dca2a69066a">s</a>-&gt;Close();</div><div class="line">         --clientCount;</div><div class="line">         <span class="keywordflow">if</span> (mon-&gt;<a class="code" href="classTMonitor.html#a6dafe5beeb5bb2e9715f2f2a5bcb33c7">GetActive</a>() == 0 || clientCount == 0) {</div><div class="line">            printf(<span class="stringliteral">&quot;No more active clients... stopping\n&quot;</span>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">         }</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mess-&gt;<a class="code" href="classTMessage.html#a3d6f99eeb25fe7cc5cbe1d54862e42b5">What</a>() == <a class="code" href="MessageTypes_8h.html#a2c9d6c5dbd9cd6158973ec7f1986f9b9a1f55439e32a14c38f4f3d29ce94b4e76">kMESS_ANY</a>) {</div><div class="line"></div><div class="line">         <a class="code" href="RtypesCore_8h.html#adaf6e69e06203ab5ae4994d1e7590647">Long64_t</a> length;</div><div class="line">         <a class="code" href="classTString.html">TString</a> filename;</div><div class="line">         <a class="code" href="RtypesCore_8h.html#a3885b911a54b47a4e61671f45dd45d0b">Int_t</a> clientId;</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#a9be9caf68377c5de8aea44a6809b9d0b">ReadInt</a>(clientId);</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#a9646f9684a5c20d093b6b8a13ea502fa">ReadTString</a>(filename);</div><div class="line">         mess-&gt;<a class="code" href="classTBufferFile.html#a5ff82748cfd80c029b08ca8506b631ae">ReadLong64</a>(length); <span class="comment">// &#39;*mess &gt;&gt; length;&#39; is broken in CINT for Long64_t.</span></div><div class="line"></div><div class="line">         <span class="comment">// Info(&quot;fastMergeServerHist&quot;,&quot;Received input from client %d for %s&quot;,clientId,filename.Data());</span></div><div class="line"></div><div class="line">         <a class="code" href="classTMemFile.html">TMemFile</a> *<span class="keyword">transient</span> = <span class="keyword">new</span> <a class="code" href="classTMemFile.html">TMemFile</a>(filename,mess-&gt;<a class="code" href="classTBuffer.html#af22ffe394903a7d18505a0b60de63fe8">Buffer</a>() + mess-&gt;<a class="code" href="classTBuffer.html#af384bb472e426a724c6c0adfa0399746">Length</a>(),length,<span class="stringliteral">&quot;UPDATE&quot;</span>); <span class="comment">// UPDATE because we need to remove the TTree after merging them.</span></div><div class="line">         mess-&gt;<a class="code" href="classTBuffer.html#aa73e88d4c85ee71a28947532692bfb68">SetBufferOffset</a>(mess-&gt;<a class="code" href="classTBuffer.html#af384bb472e426a724c6c0adfa0399746">Length</a>()+length);</div><div class="line"></div><div class="line">         <span class="keyword">const</span> <a class="code" href="RtypesCore_8h.html#aeea98adf47c4604318761944f6780133">Float_t</a> clientThreshold = 0.75; <span class="comment">// control how often the histogram are merged.  Here as soon as half the clients have reported.</span></div><div class="line"></div><div class="line">         ParallelFileMerger *info = (ParallelFileMerger*)mergers.<a class="code" href="classTHashTable.html#abbe4c8a55f4362b70e3194bf4e6a49ff">FindObject</a>(filename);</div><div class="line">         <span class="keywordflow">if</span> (!info) {</div><div class="line">            info = <span class="keyword">new</span> ParallelFileMerger(filename,cache);</div><div class="line">            mergers.<a class="code" href="classTHashTable.html#a4cc754142e42ee7b20e5a08df95066da">Add</a>(info);</div><div class="line">         }</div><div class="line"></div><div class="line">         <span class="keywordflow">if</span> (R__NeedInitialMerge(<span class="keyword">transient</span>)) {</div><div class="line">            info-&gt;InitialMerge(<span class="keyword">transient</span>);</div><div class="line">         }</div><div class="line">         info-&gt;RegisterClient(clientId,<span class="keyword">transient</span>);</div><div class="line">         <span class="keywordflow">if</span> (info-&gt;NeedMerge(clientThreshold)) {</div><div class="line">            <span class="comment">// Enough clients reported.</span></div><div class="line">            <a class="code" href="TError_8h.html#a39df8069c2b64976c8e9330743e1b145">Info</a>(<span class="stringliteral">&quot;fastMergeServerHist&quot;</span>,<span class="stringliteral">&quot;Merging input from %ld clients (%d)&quot;</span>,info-&gt;fClients.size(),clientId);</div><div class="line">            info-&gt;Merge();</div><div class="line">         }</div><div class="line">         <span class="keyword">transient</span> = 0;</div><div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mess-&gt;<a class="code" href="classTMessage.html#a3d6f99eeb25fe7cc5cbe1d54862e42b5">What</a>() == <a class="code" href="MessageTypes_8h.html#a2c9d6c5dbd9cd6158973ec7f1986f9b9a52cb40b3ca0a13457d86dbb71c0077fb">kMESS_OBJECT</a>) {</div><div class="line">         printf(<span class="stringliteral">&quot;got object of class: %s\n&quot;</span>, mess-&gt;<a class="code" href="classTMessage.html#afd7891b7f1876096253caaab14b6e700">GetClass</a>()-&gt;<a class="code" href="classTNamed.html#a42e3142d30b08fed1b07216d4a36b090">GetName</a>());</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">         printf(<span class="stringliteral">&quot;*** Unexpected message ***\n&quot;</span>);</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="keyword">delete</span> mess;</div><div class="line">   }</div><div class="line"></div><div class="line">   <a class="code" href="classTIter.html">TIter</a> next(&amp;mergers);</div><div class="line">   ParallelFileMerger *info;</div><div class="line">   <span class="keywordflow">while</span> ( (info = (ParallelFileMerger*)next()) ) {</div><div class="line">      <span class="keywordflow">if</span> (info-&gt;NeedFinalMerge())</div><div class="line">      {</div><div class="line">         info-&gt;Merge();</div><div class="line">      }</div><div class="line">   }</div><div class="line"></div><div class="line">   mergers.<a class="code" href="classTHashTable.html#abcad19f2fc40cebbcb50343e7c46e9d7">Delete</a>();</div><div class="line">   <span class="keyword">delete</span> mon;</div><div class="line">   <span class="keyword">delete</span> ss;</div><div class="line">}</div></div><!-- fragment --><dl class="section author"><dt>Author</dt><dd>Fons Rademakers </dd></dl>

<p class="definition">Definition in file <a class="el" href="parallelMergeServer_8C_source.html">parallelMergeServer.C</a>.</p>
</div></div><!-- contents -->
<html>
<body>
<div id="footer" style="background-color:#E5EBF3;">
<small>
<img class="footer" src="rootlogo_s.gif" alt="root"/></a>
ROOT 6.18/03 - Reference Guide Generated on Thu Aug 29 2019 04:10:20 (GVA Time) using Doxygen 1.8.14.
</small>
</div>
</body>
</html>
