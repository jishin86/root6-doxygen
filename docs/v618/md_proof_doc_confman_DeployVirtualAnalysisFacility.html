<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>ROOT: Deploying the Virtual Analysis Facility</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="./mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ROOT.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table bgcolor="#346295" cellspacing="0" cellpadding="0">
  <tr>
    <td> <img style="height:90px" alt="Logo" src="rootlogo.gif"/> </td>
    <td valign="middle" style="color: #FFFFFF" nowrap="nowrap"><font size="6">ROOT</font> &#160; 6.18/03 <br> Reference Guide </td>
    <td style="width:100%"> </td>
  </tr>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Deploying the Virtual Analysis Facility </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Introduction </h2>
<p>Thanks to CernVM and PROOF on Demand, it is possible to deploy a ready to use Virtual Analysis Facility on your cloud (either public, private or even your desktop computer).</p>
<p>On the server side, "configuring" the Virtual Analysis Facility is simply a matter of starting a certain number of CernVM virtual machines that will become part of your PROOF cluster. CernVM uses contextualization to specialize each virtual machine to be either a head node or a worker node.</p>
<p>The Virtual Analysis Facility comes with many preconfigured things:</p>
<ul>
<li>a HTCondor cluster capable of running PROOF on Demand</li>
<li>certificate authentication</li>
<li>your experiment's software (if available on CernVM-FS)</li>
</ul>
<h2>Obtain the CernVM image and contextualization </h2>
<h3>Download the CernVM bare image</h3>
<p>The Virtual Analysis Facility currently works with <em>CernVM Batch 2.7.1 64-bit</em>. This means that you need to have this CernVM image available either on your local hard disk (in case of a desktop deployment) or in your cloud's image repository.</p>
<blockquote class="doxtable">
<p>For convenience we provide the direct link for the working versions:</p>
<ul>
<li><a href="https://cernvm.cern.ch/releases/19/cernvm-batch-node-2.7.1-2-3-x86_64.hdd.gz">CernVM 2.7.1 batch 64-bit for <b>KVM</b></a></li>
<li><a href="https://cernvm.cern.ch/releases/19/cernvm-batch-node-2.7.1-2-3-x86_64.ext3.gz">CernVM 2.7.1 batch 64-bit for <b>Xen</b></a></li>
</ul>
<p>Images are gzipped. In most cases you'll need to gunzip them before registering to your image repository. </p>
</blockquote>
<h3>Create VM configuration profiles</h3>
<p>CernVM images are base images supporting boot-time customization via configuration profiles called "contexts". <a class="el" href="classContext.html" title="Small helper to keep current directory context. ">Context</a> creation can be performed through the <a href="https://cernvm-online.cern.ch/">CernVM Online</a> website. The site is immediately accessible if you have a CERN account.</p>
<p>Go to your <a href="https://cernvm-online.cern.ch/dashboard">CernVM Online Dashboard</a>, click on the <b>Create new context...</b> dropdown and select <b>Virtual Analysis Facility node</b>.</p>
<p>There's only a few parameters to configure.</p>
<p><a class="el" href="classContext.html" title="Small helper to keep current directory context. ">Context</a> name : A name for your context (such as <em>VAF Master for ATLAS</em>). Any name will work.</p>
<p>Role : Use this to configure either a <em>master</em> or a <em>slave</em>.</p>
<p>VAF master (only available when configuring a slave) : IP address or FQDN of the Virtual Analysis Facility master.</p>
<p>Auth method : Choose between <em>ALICE LDAP</em> (useful only for ALICE users) or <em>Pool accounts</em> (good for authenticating all the other Grid users).</p>
<p>Num. pool accounts (only available when using pool accounts auth) : Number of pool accounts to create.</p>
<p>Proxy for CVMFS : An URL specifying the proxy server for CernVM-FS, such as <code><a href="http://ca-proxy.cern.ch:3128/">http://ca-proxy.cern.ch:3128/</a></code>. If you leave it empty, proxy will be automatically discovered.</p>
<p>HTCondor shared secret : VMs part of the same cluster should have the same value of this field. It is used to mutually authenticate VMs and it is used like a password.</p>
<p><a class="el" href="classContext.html" title="Small helper to keep current directory context. ">Context</a> password : Current profile will be saved on the <a href="http://cernvm-online.cern.ch/">CernVM Online repository</a>. If you don't want the information there to be publicly available to other users, type in a value for protecting the context with an encryption password.</p>
<p>You will have to create a profile for the <b>master</b> and the <b>slave</b>. Since most of the configuration variables are the same (like the <em>HTCondor shared secret</em>) you can create one, clone it and change only what's needed to change.</p>
<h2>Deploy it on the cloud </h2>
<p>Provided you have access to a certain cloud API, you'll need to instantiate a certain number of CernVM batch images with proper contextualization: one for the master, as many as you want as slaves.</p>
<p>CernVM supports contextualization through the "user data" field supported by all cloud infrastructures.</p>
<p>Each cloud infrastructure has a different method of setting the "user
data". The following description will focus on:</p>
<ul>
<li><a href="http://opennebula.org/">OpenNebula</a></li>
<li>OpenStack (such as the <a href="https://openstack.cern.ch/">CERN Agile infrastructure</a>)</li>
<li><a href="http://aws.amazon.com/ec2/">Amazon EC2</a>-compatible interfaces via the open <a href="http://www.eucalyptus.com/">Eucalyptus</a> <a href="http://www.eucalyptus.com/eucalyptus-cloud/tools">Euca2ools</a>: many popular clouds support such interface and tools</li>
</ul>
<h3>Download the CernVM Online contextualizations</h3>
<p>Go to the CernVM Online Dashboard page where you have previously customized the contexts for your master and your slaves.</p>
<p>Click on the rightmost button on the line of the desired context and select <b>Get rendered context</b> from the dropdown: save the output to a text file (such as <code>my_vaf_context.txt</code>, the name we will use in the examples that follow). This file will be subsequently passed as the so called "user-data" file to the cloud API.</p>
<blockquote class="doxtable">
<p>Repeat the operation for both the master context and the slave context. </p>
</blockquote>
<h3>OpenStack API: nova</h3>
<p>Example of a CernVM instantiation using <code>nova</code>:</p>
<div class="fragment"><div class="line">nova boot \</div><div class="line">  --flavor m1.xlarge \</div><div class="line">  --image cernvm-batch-node-2.6.0-4-1-x86_64 \</div><div class="line">  --key-name my_default_keyparir \</div><div class="line">  --user-data my_vaf_context.txt \</div><div class="line">  Name-Of-My-New-VM</div></div><!-- fragment --><p>The <code>--user-data</code> option requires the context file we've just downloaded.</p>
<h3>EC2 API: euca-tools</h3>
<p>Example of a CernVM instantiation using <code>euca-tools</code>:</p>
<div class="fragment"><div class="line">euca-run-instances \</div><div class="line">  --instance-type m1.xlarge \</div><div class="line">  --key my_default_keyparir \</div><div class="line">  --user-data-file my_vaf_context.txt \</div><div class="line">  cernvm-batch-node-2.6.0-4-1-x86_64</div></div><!-- fragment --><p>The <code>--user-data-file</code> option is the context file we've just downloaded.</p>
<h3>OpenNebula</h3>
<p>An example VM definition follows:</p>
<div class="fragment"><div class="line">CONTEXT=[</div><div class="line">  EC2_USER_DATA=&quot;&lt;base64_encoded_string&gt;&quot;,</div><div class="line">]</div><div class="line">CPU=&quot;6&quot;</div><div class="line">VCPU=&quot;6&quot;</div><div class="line">DISK=[</div><div class="line">  IMAGE=&quot;cernvm-batch-node-2.6.0-4-1-x86_64&quot;,</div><div class="line">  TARGET=&quot;vda&quot; ]</div><div class="line">MEMORY=&quot;16000&quot;</div><div class="line">NAME=&quot;CernVM-VAF-Node&quot;</div><div class="line">NIC=[</div><div class="line">  NETWORK=&quot;My-OpenNebula-VNet&quot; ]</div><div class="line">OS=[</div><div class="line">  ARCH=&quot;x86_64&quot; ]</div></div><!-- fragment --><p>The <code>&lt;base64_encoded_string&gt;</code> requires the base64 version of the whole downloaded context definition. You can obtain it by running: </p><pre class="fragment">cat my_vaf_context.txt | base64 | tr -d '\n'
</pre><h2>Network security groups </h2>
<p>In order to make the Virtual Analysis Facility work properly, the firewall of your infrastructure must be configured to allow some connections.</p>
<p>Some ports need to allow "external" connections while other ports might be safely opened to allow only connections from other nodes of the Virtual Analysis Facility.</p>
<h3>Ports to open on all nodes</h3>
<p>HTCondor ports : Allow <b>TCP and UDP range 9600-9700</b> only between nodes of the Virtual Analysis Facility.</p>
<p>Only HTCondor and PoD communication is needed between the nodes. No HTCondor ports need to be opened to the world.</p>
<h3>Additional ports to open on the front end node</h3>
<p>HTTPS : Allow <b>TCP 443</b> from all</p>
<p>SSH : Allow <b>TCP 22</b> from all</p>
<p>No other ports need to be opened from the outside. Your definition of <em>allow from all</em> might vary. </p>
</div></div><!-- contents -->
<html>
<body>
<div id="footer" style="background-color:#E5EBF3;">
<small>
<img class="footer" src="rootlogo_s.gif" alt="root"/></a>
ROOT 6.18/03 - Reference Guide Generated on Thu Aug 29 2019 04:10:40 (GVA Time) using Doxygen 1.8.14.
</small>
</div>
</body>
</html>
